name: Auto Cleanup Old Deployments
on:
  workflow_run:
    workflows: ["Upstream Sync"]  # 改为仓库中实际的同步工作流名称！！！
    types: [completed]  # 同步完成后触发清理

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: 安装 jq 和最新版 wrangler
        run: |
          sudo apt-get install -y jq
          npm install -g wrangler
          
      - name: 强制清理旧部署（仅保留最新2个）
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          DEPLOY_IDS=$(wrangler pages deployment list libretv --account-id=$CLOUDFLARE_ACCOUNT_ID --format=json | jq -r '.[].id' | tail -n +3)
          if [ -n "$DEPLOY_IDS" ]; then
            echo "删除旧部署: $DEPLOY_IDS"
            for ID in $DEPLOY_IDS; do
              wrangler pages deployment delete libretv --account-id=$CLOUDFLARE_ACCOUNT_ID --deployment-id=$ID --yes
            done
          else
            echo "无需清理，仅保留了最新2个部署"
          fi
